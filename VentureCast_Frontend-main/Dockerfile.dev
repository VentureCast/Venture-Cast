# Development Dockerfile for React Native with hot-reload
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    bash \
    git \
    openssh

# Install watchman for better file watching on macOS/Linux
RUN apk add --no-cache --virtual .build-deps \
    autoconf \
    automake \
    libtool \
    linux-headers \
    python3-dev && \
    cd /tmp && \
    git clone https://github.com/facebook/watchman.git && \
    cd watchman && \
    git checkout v2023.08.14.00 && \
    ./autogen.sh && \
    ./configure --without-python --without-pcre --enable-lenient && \
    make && \
    make install && \
    cd / && \
    rm -rf /tmp/watchman && \
    apk del .build-deps

# Copy package files
COPY package.json yarn.lock ./
COPY .yarnrc.yml ./
COPY .yarn ./.yarn

# Enable Yarn Berry
RUN corepack enable && \
    corepack prepare yarn@3.6.4 --activate

# Install dependencies
RUN yarn install

# Expose ports
EXPOSE 8081
EXPOSE 8097
EXPOSE 19000
EXPOSE 19001

# Start Metro bundler with reset cache option
CMD ["yarn", "start", "--reset-cache", "--host", "0.0.0.0"]